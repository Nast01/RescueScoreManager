<UserControl x:Class="RescueScoreManager.Modules.Forfeit.ForfeitView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:converter="clr-namespace:RescueScoreManager.Converter"
             xmlns:loc="clr-namespace:RescueScoreManager.Localization"  
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="800">
  <UserControl.Resources>
    <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    <converter:PoolVisibilityConverter x:Key="PoolVisibilityConverter"/>
    <converter:ReverseBooleanToVisibilityConverter x:Key="ReverseBooleanToVisibilityConverter"/>

    <Style x:Key="SearchTextBoxStyleCompact" TargetType="TextBox" BasedOn="{StaticResource MaterialDesignOutlinedTextBox}">
      <Setter Property="materialDesign:HintAssist.Hint" Value="Search athletes..."/>
      <Setter Property="materialDesign:HintAssist.IsFloating" Value="True"/>
      <Setter Property="materialDesign:HintAssist.Foreground" Value="DarkGray"/>
      <Setter Property="materialDesign:HintAssist.Background" Value="Transparent"/>
      <Setter Property="Margin" Value="0,4,0,0"/>
      <!-- Reduced from 0,8 -->
      <Setter Property="VerticalAlignment" Value="Center"/>
      <Setter Property="materialDesign:HintAssist.HelperTextFontSize" Value="12"/>
      <Setter Property="Height" Value="Auto"/>
      <Setter Property="MinHeight" Value="48"/>
    </Style>

    <Style x:Key="AthleteCardStyle" TargetType="materialDesign:Card">
      <Setter Property="Margin" Value="4"/>
      <Setter Property="Padding" Value="12"/>
      <Setter Property="materialDesign:ElevationAssist.Elevation" Value="Dp2"/>
      <Style.Triggers>
        <Trigger Property="IsMouseOver" Value="True">
          <Setter Property="materialDesign:ElevationAssist.Elevation" Value="Dp4"/>
        </Trigger>
      </Style.Triggers>
    </Style>

    <!-- Custom CheckBox Style for better visibility -->
    <!-- Custom CheckBox Style for better visibility -->
    <Style x:Key="ForfeitCheckBoxStyle" TargetType="CheckBox">
      <Setter Property="Width" Value="18"/>
      <Setter Property="Height" Value="18"/>
      <Setter Property="Margin" Value="0,0,12,0"/>
      <Setter Property="VerticalAlignment" Value="Center"/>
      <Setter Property="Cursor" Value="Hand"/>
      <Setter Property="Template">
        <Setter.Value>
          <ControlTemplate TargetType="CheckBox">
            <Grid>
              <Border x:Name="CheckboxBorder"
                                    Width="18"
                                    Height="18"
                                    Background="White"
                                    BorderBrush="#999999"
                                    BorderThickness="2"
                                    CornerRadius="2"/>
              <materialDesign:PackIcon x:Name="CheckIcon"
                                                     Kind="Check"
                                                     Width="12"
                                                     Height="12"
                                                     Foreground="White"
                                                     HorizontalAlignment="Center"
                                                     VerticalAlignment="Center"
                                                     Visibility="Collapsed"/>
            </Grid>
            <ControlTemplate.Triggers>
              <Trigger Property="IsChecked" Value="True">
                <Setter TargetName="CheckboxBorder" Property="Background" Value="#F44336"/>
                <Setter TargetName="CheckboxBorder" Property="BorderBrush" Value="#F44336"/>
                <Setter TargetName="CheckIcon" Property="Visibility" Value="Visible"/>
              </Trigger>
              <Trigger Property="IsMouseOver" Value="True">
                <Setter TargetName="CheckboxBorder" Property="BorderBrush" Value="#2196F3"/>
              </Trigger>
              <DataTrigger Binding="{Binding IsChecked, RelativeSource={RelativeSource Self}}" Value="True">
                <Setter TargetName="CheckboxBorder" Property="Background" Value="#F44336"/>
                <Setter TargetName="CheckboxBorder" Property="BorderBrush" Value="#F44336"/>
              </DataTrigger>
              <DataTrigger Binding="{Binding IsChecked, RelativeSource={RelativeSource Self}}" Value="False">
                <Setter TargetName="CheckboxBorder" Property="Background" Value="White"/>
                <Setter TargetName="CheckboxBorder" Property="BorderBrush" Value="#999999"/>
              </DataTrigger>
            </ControlTemplate.Triggers>
          </ControlTemplate>
        </Setter.Value>
      </Setter>
    </Style>
  </UserControl.Resources>
  <!-- Main Content -->
  <Grid Visibility="{Binding IsLoading, Converter={StaticResource ReverseBooleanToVisibilityConverter}}">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
      <RowDefinition Height="Auto"/>
    </Grid.RowDefinitions>
    <!-- Search Controls -->
    <Border Grid.Row="0"
            Grid.Column="0"
            Margin="10,8"
            Style="{StaticResource whiteBorder}">
      <Grid Grid.Row="1" Margin="16,0,16,16">
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*"/>
          <ColumnDefinition Width="16"/>
          <ColumnDefinition Width="*"/>
          <ColumnDefinition Width="16"/>
          <ColumnDefinition Width="Auto"/>
        </Grid.ColumnDefinitions>

        <!-- Search by Name -->
        <TextBox Grid.Column="0"
                Text="{Binding SearchByName, UpdateSourceTrigger=PropertyChanged}"
                Style="{StaticResource SearchTextBoxStyleCompact}"
                materialDesign:HintAssist.Hint="{loc:Translate SearchByAthleteName}"/>

        <!-- Search by Club -->
        <TextBox Grid.Column="2"
                     Text="{Binding SearchByClub, UpdateSourceTrigger=PropertyChanged}"
                     Style="{StaticResource SearchTextBoxStyleCompact}"
                     materialDesign:HintAssist.Hint="{loc:Translate SearchByClubName}"/>

        <!-- Clear Filters -->
        <Button Grid.Column="4"
                    Command="{Binding ClearFiltersCommand}"
                    Style="{StaticResource MaterialDesignOutlinedButton}"
                    ToolTip="{loc:Translate Clear}"
                    Margin="0,8"
                    VerticalAlignment="Center">
          <Button.Content>
            <materialDesign:PackIcon Kind="Refresh" Margin="0,0,4,0"/>
          </Button.Content>
        </Button>
      </Grid>
    </Border>
    <!-- Athletes List -->
    <Border Grid.Row="2" 
            Margin="10,8"
            Style="{StaticResource whiteBorder}">
      <ScrollViewer Margin="16,0">
        <ItemsControl ItemsSource="{Binding FilteredAthletes}">
          <ItemsControl.ItemTemplate>
            <DataTemplate>
              <materialDesign:Card Style="{StaticResource AthleteCardStyle}">
                <Grid>
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                  </Grid.ColumnDefinitions>
                  <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                  </Grid.RowDefinitions>

                  <!-- Athlete Info -->
                  <StackPanel Grid.Column="0" Grid.RowSpan="3">
                    <TextBlock Text="{Binding FullName}" 
                                               Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                                               FontWeight="SemiBold"/>
                    <TextBlock Text="{Binding Club.Name}" 
                                               Style="{StaticResource MaterialDesignBody2TextBlock}"
                                               Foreground="{DynamicResource MaterialDesignBodyLight}"/>
                    <TextBlock Text="{Binding LicenseeNumber}" 
                                               Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                               Foreground="{DynamicResource MaterialDesignBodyLight}"/>
                  </StackPanel>

                  <!-- Team Actions -->
                  <StackPanel Grid.Column="2" Grid.Row="0"
                                            VerticalAlignment="Top"
                                            Margin="8,0,0,0">

                    <!-- Forfeit All Teams Button -->
                    <Button Command="{Binding DataContext.ForfeitAllTeamsCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}"
                                            Style="{StaticResource MaterialDesignOutlinedButton}"
                                            Margin="0,4"
                                            ToolTip="{loc:Translate ForfeitAll}">
                      <Button.Content>
                        <StackPanel Orientation="Horizontal">
                          <materialDesign:PackIcon Kind="AccountGroup" Margin="0,0,4,0"/>
                          <TextBlock Text="{loc:Translate ForfeitAll}"/>
                        </StackPanel>
                      </Button.Content>
                    </Button>

                    <!-- Restore All Teams Button -->
                    <Button Command="{Binding DataContext.RestoreAllTeamsCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}"
                                            Style="{StaticResource MaterialDesignOutlinedButton}"
                                            Margin="0,4"
                                            ToolTip="{loc:Translate RestoreThisAthleteToAllTheirTeams}">
                      <Button.Content>
                        <StackPanel Orientation="Horizontal">
                          <materialDesign:PackIcon Kind="AccountCheck" Margin="0,0,4,0"/>
                          <TextBlock Text="{loc:Translate RestoreAll}"/>
                        </StackPanel>
                      </Button.Content>
                    </Button>
                  </StackPanel>

                  <!-- Team Details -->
                  <Expander Grid.Column="0" Grid.ColumnSpan="3" Grid.Row="2"
                                          Margin="0,8,0,0"
                                          Visibility="{Binding HasTeams, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <Expander.Header>
                      <StackPanel Orientation="Horizontal" HorizontalAlignment="Left">
                        <TextBlock Text="{loc:Translate TeamDetails}"
                                  Margin="0,0,12,0"
                                  VerticalAlignment="Center"
                                  Style="{StaticResource MaterialDesignBody2TextBlock}"/>

                        <!-- Forfeit Status Indicator -->
                        <StackPanel Orientation="Horizontal">

                          <!-- Status Icon -->
                          <materialDesign:PackIcon Width="16" Height="16" Margin="0,0,4,0" VerticalAlignment="Center">
                            <materialDesign:PackIcon.Style>
                              <Style TargetType="materialDesign:PackIcon">
                                <Setter Property="Kind" Value="CheckCircle"/>
                                <Setter Property="Foreground" Value="#4CAF50"/>
                                <Style.Triggers>
                                  <DataTrigger Binding="{Binding HasAllTeamsForfeited}" Value="True">
                                    <Setter Property="Kind" Value="CloseCircle"/>
                                    <Setter Property="Foreground" Value="#F44336"/>
                                  </DataTrigger>
                                  <DataTrigger Binding="{Binding HasPartialForfeit}" Value="True">
                                    <Setter Property="Kind" Value="MinusCircle"/>
                                    <Setter Property="Foreground" Value="#FF9800"/>
                                  </DataTrigger>
                                </Style.Triggers>
                              </Style>
                            </materialDesign:PackIcon.Style>
                          </materialDesign:PackIcon>

                          <!-- Status Text -->
                          <TextBlock Text="{Binding ForfeitStatusText,UpdateSourceTrigger=PropertyChanged,Mode=OneWay}" 
                                      VerticalAlignment="Center"
                                      Margin="0,0,8,0">
                            <TextBlock.Style>
                              <Style TargetType="TextBlock" BasedOn="{StaticResource MaterialDesignCaptionTextBlock}">
                                <Setter Property="Foreground" Value="#4CAF50"/>
                                <Style.Triggers>
                                  <DataTrigger Binding="{Binding HasAllTeamsForfeited}" Value="True">
                                    <Setter Property="Foreground" Value="#F44336"/>
                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                  </DataTrigger>
                                  <DataTrigger Binding="{Binding HasPartialForfeit}" Value="True">
                                    <Setter Property="Foreground" Value="#FF9800"/>
                                    <Setter Property="FontWeight" Value="Medium"/>
                                  </DataTrigger>
                                </Style.Triggers>
                              </Style>
                            </TextBlock.Style>
                          </TextBlock>

                          <!-- Team Count Badge -->
                          <Border Background="{DynamicResource MaterialDesignDivider}" 
                                                            CornerRadius="8" 
                                                            Padding="4,2"
                                                            VerticalAlignment="Center">
                            <TextBlock Text="{Binding TotalTeamsNumber, StringFormat=' {0}'}" FontWeight="Bold"
                                        Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                        FontSize="10" HorizontalAlignment="Center" VerticalAlignment="Center"
                                        Foreground="{DynamicResource MaterialDesignBody}"/>
                          </Border>
                        </StackPanel>
                      </StackPanel>
                    </Expander.Header>
                    <ItemsControl ItemsSource="{Binding Teams,UpdateSourceTrigger=PropertyChanged,Mode=TwoWay}" Margin="16,8">
                      <ItemsControl.ItemTemplate>
                        <DataTemplate>
                          <Grid Margin="0,4">
                            <Grid.ColumnDefinitions>
                              <ColumnDefinition Width="Auto"/>
                              <ColumnDefinition Width="*"/>
                              <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                              <RowDefinition Height="Auto"/>
                              <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <!-- Forfeit CheckBox (Left side) -->
                            <CheckBox Grid.Column="0"
                                      Grid.Row="0"
                                      IsChecked="{Binding IsForfeit,UpdateSourceTrigger=PropertyChanged,Mode=TwoWay}"
                                      Style="{StaticResource ForfeitCheckBoxStyle}"
                                      ToolTip="{loc:Translate ToggleTeamForfeitStatus}"/>

                            <!-- Race and Category Info -->
                            <StackPanel Grid.Column="1" Grid.Row="0">
                              <TextBlock Text="{Binding RaceName}" 
                                                                   Style="{StaticResource MaterialDesignBody2TextBlock}"/>
                              <TextBlock Text="{Binding CategoryName}" 
                                                                   Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                                                   Foreground="{DynamicResource MaterialDesignBodyLight}"/>
                            </StackPanel>

                            <!-- Entry Time Label (only for Pool races) -->
                            <StackPanel Grid.Column="1" Grid.Row="1"
                                        Orientation="Horizontal"
                                        Visibility="{Binding RaceSpeciality, Converter={StaticResource PoolVisibilityConverter}}"
                                        Margin="0,4,0,0">
                              <materialDesign:PackIcon Kind="Timer" 
                                                        Width="14" 
                                                        Height="14" 
                                                        Margin="0,0,4,0"
                                                        VerticalAlignment="Center"
                                                        Foreground="{DynamicResource MaterialDesignBodyLight}"/>
                              <TextBlock Text="{Binding EntryTimeLabel, StringFormat='Entry Time: {0}'}" 
                                        Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                        Foreground="{DynamicResource MaterialDesignBodyLight}"
                                        FontStyle="Italic"/>
                            </StackPanel>
                          </Grid>
                        </DataTemplate>
                      </ItemsControl.ItemTemplate>
                    </ItemsControl>
                  </Expander>
                </Grid>
              </materialDesign:Card>
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>
      </ScrollViewer>
    </Border>
    <!-- Status Bar -->
    <Border Grid.Row="3" 
                Background="{DynamicResource MaterialDesignPaper}"
                BorderBrush="{DynamicResource MaterialDesignDivider}"
                BorderThickness="0,1,0,0"
                Padding="16,8">
      <Grid>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*"/>
          <ColumnDefinition Width="Auto"/>
        </Grid.ColumnDefinitions>

        <TextBlock Grid.Column="0"
                           Text="{Binding StatusText}"
                           Style="{StaticResource MaterialDesignCaptionTextBlock}"
                           VerticalAlignment="Center"/>

        <StackPanel Grid.Column="1" 
                            Orientation="Horizontal">
          <TextBlock Text="{Binding FilteredAthletes.Count, StringFormat='Athletes: {0}'}"
                               Style="{StaticResource MaterialDesignCaptionTextBlock}"
                               VerticalAlignment="Center"
                               Margin="0,0,16,0"/>

          <Button Command="{Binding SaveChangesCommand}"
                            Style="{StaticResource MaterialDesignRaisedButton}"
                            Content="{loc:Translate Save}"
                            IsEnabled="{Binding HasUnsavedChanges}"/>
        </StackPanel>
      </Grid>
    </Border>
  </Grid>
</UserControl>
